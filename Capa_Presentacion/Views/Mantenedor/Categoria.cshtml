@{
    ViewData["Title"] = "Categoria";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    ViewData["Breadcrumbs"] = new List<Dictionary<string, string>>
    {
        new() { { "Titulo", "Mantenimiento" }, { "Url", "#" } },
        new() { { "Titulo", "Categoria" }, { "Url", "Categoria" } }
    };
    @await Html.PartialAsync("./Components/_BreadCrumb")
}

@{
    // Aquí defines los campos del formulario dinámico
    ViewData["CamposFormulario"] = new List<FormFieldViewModel>
    {
        new()
        {
            Container_Label = "Descripción",
            Input_Type = "text",
            Input_Placeholder = "Ingrese la descripción",
            Form_Id = "txtDescripcion"
        },
        new()
        {
            Container_Label = "Activo",
            Input_Type = "select",
            Form_Id = "cboActivo",
            Select_Options = new Dictionary<string, string>
            {
                { "1", "Sí" },
                { "0", "No" }
            }
        }
    };
}

<div class="card">
    <div class="card-header">
        <i class="fas fa-users me-1"></i> Lista de Categorias
    </div>
    <div class="card-body position-relative">
        <div class="row">
            <div class="col-12">
                @{
                    ViewData["IdModal"] = "FormModal";
                    ViewData["Titulo"] = "Crear Nueva Categoria";
                }
                @await Html.PartialAsync("./Components/_ModalView")

                <button type="button" id="btnGuardar" class="btn btn-success px-3" data-bs-toggle="modal" data-bs-target="#FormModal">Nueva Categoria <i class="fas fa-user ms-2"></i></button>
            </div>
        </div>

        @*<hr />*@

        <div id="tablaContainer" class="border-top border-dark mt-3 pb-4">
            <table id="idTabla" class="table table-hover table-bordered align-middle text-secondary" style="width: 100%">
                <thead class="table-dark">
                    <tr>
                        <th>Descripción</th>
                        <th>Activo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody id="tableBody" class="text-secondary"></tbody>
            </table>

            <!-- 🟢 Spinner para la tabla -->
            <div id="spinnerTabla"
                 class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-light bg-opacity-75"
                 style="z-index:1050; border-radius:0.375rem;">
                @await Html.PartialAsync("./Components/_Spinner")
            </div>
        </div>

    </div>
</div>

<style>
    .swal2-confirm{ margin-left: 5px; }

    .swal2-cancel{ margin-right: 5px; }
</style>

@section Scripts {
    <script>
        let modoEdicion = false;
        let idUsuarioEditando = 0;

        $(document).ready(function () {
            const $spinner = $('#spinnerTabla');

            // 🔹 Mostrar spinner antes de comenzar
            $spinner.removeClass('d-none');

            $.get({
                url: '@Url.Action("ListarCategorias", "Mantenedor")',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8'
            })
            .done(function (data) {
                var $tbody = $('#tableBody');

                $.each(data.listData, function(_, c) {
                    $tbody.append(
                        $('<tr>').append(
                            $('<td>').addClass('pt-2').text(c.description),
                            $('<td>').addClass('pt-2').append(
                                c.activo
                                    ? $('<span>').addClass('badge bg-success').text('Sí')
                                    : $('<span>').addClass('badge bg-danger').text('No')
                            ),
                            $('<td>').addClass('pt-2').append(
                                $('<button>')
                                    .addClass('btn btn-primary btn-sm btn-editar')
                                    .attr({
                                        'data-id': c.idCategoria,
                                        'data-description': c.description,
                                        'data-activo': c.activo
                                    })
                                    .html('<i class="fas fa-pen"></i>'),
                                $('<button>')
                                    .addClass('btn btn-danger btn-sm ms-1 btn-eliminar') // Boton de Eliminar
                                    .attr('data-id', c.idCategoria)
                                    .append($('<i>').addClass('fas fa-trash')) // icono de Eliminar
                            )
                        )
                    );
                });

                let dataTable = {
                    responsive: true,
                    ordering: false,
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json'
                    },
                    columnDefs: [
                        {
                            targets: 2,
                            orderable: false, // No se puede ordenar con clic
                            searchable: false, // No se incluye en la búsqueda
                            width: "100px", //Fija el ancho a 90px
                            //className: 'text-center' // Centra el contenido
                        }
                    ]
                }

                new DataTable('#idTabla', dataTable);
            })
            .fail(function (xhr) {
                console.error('Error al cargar las categorias:', xhr);
            })
            .always(function () {
                // 🔹 Ocultar el spinner siempre (éxito o error)
                $spinner.addClass('d-none');
            });
        });
    </script>
}